#!/usr/bin/env bash
set -e

export SCRIPTDIR="$( cd "$( dirname "$***REMOVED***BASH_SOURCE[0]***REMOVED***" )" && pwd )"
source "$***REMOVED***SCRIPTDIR***REMOVED***/.validate"

IFS=$'\n'
files=( $(validate_diff --diff-filter=ACMR --name-only -- 'pkg/*.go' || true) )
unset IFS

badFiles=()
for f in "$***REMOVED***files[@]***REMOVED***"; do
	IFS=$'\n'
	badImports=( $(go list -e -f '***REMOVED******REMOVED*** join .Deps "\n" ***REMOVED******REMOVED***' "$f" | sort -u | grep -vE '^github.com/docker/docker/pkg/' | grep -vE '^github.com/docker/docker/vendor' | grep -E '^github.com/docker/docker' || true) )
	unset IFS

	for import in "$***REMOVED***badImports[@]***REMOVED***"; do
		badFiles+=( "$f imports $import" )
	done
done

if [ $***REMOVED***#badFiles[@]***REMOVED*** -eq 0 ]; then
	echo 'Congratulations!  "./pkg/..." is safely isolated from internal code.'
else
	***REMOVED***
		echo 'These files import internal code: (either directly or indirectly)'
		for f in "$***REMOVED***badFiles[@]***REMOVED***"; do
			echo " - $f"
		done
		echo
	***REMOVED*** >&2
	false
fi
