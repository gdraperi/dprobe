#!/usr/bin/env bash

set -e
rm -rf "$DEST"

if ! command -v dockerd &> /dev/null; then
	echo >&2 'error: binary-daemon or dynbinary-daemon must be run before run'
	false
fi

DOCKER_GRAPHDRIVER=$***REMOVED***DOCKER_GRAPHDRIVER:-vfs***REMOVED***
DOCKER_USERLANDPROXY=$***REMOVED***DOCKER_USERLANDPROXY:-true***REMOVED***

# example usage: DOCKER_STORAGE_OPTS="dm.basesize=20G,dm.loopdatasize=200G"
storage_params=""
if [ -n "$DOCKER_STORAGE_OPTS" ]; then
	IFS=','
	for i in $***REMOVED***DOCKER_STORAGE_OPTS***REMOVED***; do
		storage_params="--storage-opt $i $storage_params"
	done
	unset IFS
fi


listen_port=2375
if [ -n "$DOCKER_PORT" ]; then
	IFS=':' read -r -a ports <<< "$DOCKER_PORT"
	listen_port="$***REMOVED***ports[-1]***REMOVED***"
fi

extra_params=""
if [ "$DOCKER_REMAP_ROOT" ]; then
	extra_params="--userns-remap $DOCKER_REMAP_ROOT"
fi

args="--debug \
	--host tcp://0.0.0.0:$***REMOVED***listen_port***REMOVED*** --host unix:///var/run/docker.sock \
	--storage-driver "$DOCKER_GRAPHDRIVER" \
	--userland-proxy="$DOCKER_USERLANDPROXY" \
	$storage_params \
	$extra_params"

echo dockerd $args
exec dockerd $args
