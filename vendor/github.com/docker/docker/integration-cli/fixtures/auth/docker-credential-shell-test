#!/usr/bin/env bash

set -e

listFile=shell_test_list.json

case $1 in
	"store")
		in=$(</dev/stdin)
		server=$(echo "$in" | jq --raw-output ".ServerURL")
		serverHash=$(echo "$server" | sha1sum - | awk '***REMOVED***print $1***REMOVED***')

		username=$(echo "$in" | jq --raw-output ".Username")
		password=$(echo "$in" | jq --raw-output ".Secret")
		echo "***REMOVED*** \"Username\": \"$***REMOVED***username***REMOVED***\", \"Secret\": \"$***REMOVED***password***REMOVED***\" ***REMOVED***" > $TEMP/$serverHash
		# add the server to the list file
		if [[ ! -f $TEMP/$listFile ]]; then
			echo "***REMOVED*** \"$***REMOVED***server***REMOVED***\": \"$***REMOVED***username***REMOVED***\" ***REMOVED***" > $TEMP/$listFile
		else
			list=$(<$TEMP/$listFile)
			echo "$list" | jq ". + ***REMOVED***\"$***REMOVED***server***REMOVED***\": \"$***REMOVED***username***REMOVED***\"***REMOVED***" > $TEMP/$listFile
		fi
		;;
	"get")
		in=$(</dev/stdin)
		serverHash=$(echo "$in" | sha1sum - | awk '***REMOVED***print $1***REMOVED***')
		if [[ ! -f $TEMP/$serverHash ]]; then
			echo "credentials not found in native keychain"
			exit 1
		fi
		payload=$(<$TEMP/$serverHash)
		echo "$payload"
		;;
	"erase")
		in=$(</dev/stdin)
		serverHash=$(echo "$in" | sha1sum - | awk '***REMOVED***print $1***REMOVED***')
		rm -f $TEMP/$serverHash

		# Remove the server from the list
		list=$(<$TEMP/$listFile)
		echo "$list" | jq "del(.[\"$***REMOVED***in***REMOVED***\"])" > $TEMP/$listFile
		;;
	"list")
		if [[ ! -f $TEMP/$listFile ]]; then
			echo "***REMOVED******REMOVED***"
		else
			payload=$(<$TEMP/$listFile)
			echo "$payload"
		fi
		;;
	*)
		echo "unknown credential option"
		exit 1
		;;
esac
